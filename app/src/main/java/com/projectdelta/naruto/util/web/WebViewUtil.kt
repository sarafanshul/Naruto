@file:Suppress("unused")

package com.projectdelta.naruto.util.web

import android.annotation.SuppressLint
import android.content.Context
import android.content.pm.PackageManager
import android.webkit.CookieManager
import android.webkit.WebSettings
import android.webkit.WebView
import timber.log.Timber

object WebViewUtil {
	private const val TAG = "WebViewUtil"
	const val REQUESTED_WITH = "com.android.browser"

	const val MINIMUM_WEBVIEW_VERSION = 88

	fun supportsWebView(context: Context): Boolean {
		try {
			// May throw android.webkit.WebViewFactory$MissingWebViewPackageException if WebView
			// is not installed
			CookieManager.getInstance()
		} catch (e: Throwable) {
			Timber.e(e, "supportsWebView: WebView not installed")
			return false
		}

		return context.packageManager.hasSystemFeature(PackageManager.FEATURE_WEBVIEW)
	}
}

fun WebView.isOutdated(): Boolean {
	return getWebViewMajorVersion() < WebViewUtil.MINIMUM_WEBVIEW_VERSION
}

@Suppress("DEPRECATION")
@SuppressLint("SetJavaScriptEnabled")
fun WebView.setDefaultSettings() {
	with(settings) {
		javaScriptEnabled = true
		domStorageEnabled = true
		databaseEnabled = true
		setAppCacheEnabled(true)
		useWideViewPort = true
		loadWithOverviewMode = true
		cacheMode = WebSettings.LOAD_DEFAULT
	}
}

private fun WebView.getWebViewMajorVersion(): Int {
	val uaRegexMatch = """.*Chrome/(\d+)\..*""".toRegex().matchEntire(getDefaultUserAgentString())
	return if (uaRegexMatch != null && uaRegexMatch.groupValues.size > 1) {
		uaRegexMatch.groupValues[1].toInt()
	} else {
		0
	}
}

// Based on https://stackoverflow.com/a/29218966
private fun WebView.getDefaultUserAgentString(): String {
	val originalUA: String = settings.userAgentString

	// Next call to getUserAgentString() will get us the default
	settings.userAgentString = null
	val defaultUserAgentString = settings.userAgentString

	// Revert to original UA string
	settings.userAgentString = originalUA

	return defaultUserAgentString
}